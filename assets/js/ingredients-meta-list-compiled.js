"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}$(function(){function a(){try{s=JSON.parse(u.val())}catch(a){G&&console.error("Couldn't parse ingredients:",u.val(),"Falling back to empty list",a),s=[]}r=new H(s),b(s),d(),t.sortable({update:g,start:p,stop:o,cursor:"grabbing"}),document.getElementById("sortable_list").addEventListener("click",n)}function b(a){t.empty(),a.forEach(function(a){t.append(e(a))})}function c(a){a.preventDefault();var b={title:q(w.val()),amount:q(x.val()),unit:q(y.val())};// reset form
m(b),C.forEach(function(a){return a.val("")}),w.focus()}function d(){// Enter key pressed while cursor in one of the add-new-ingredient fields.
v.click(c),A.click(function(a){return r.undo(a)}),B.click(function(a){return r.redo(a)}),$("#add-new-ingredient-title, #add-new-ingredient-amount, #add-new-ingredient-unit").on("keyup",function(a){13===a.keyCode&&c(a)}),wp.data.subscribe(function(){var a=wp.data.select("core/editor").isSavingPost(),b=wp.data.select("core/editor").isAutosavingPost();a&&!b&&z.toggle(!1)})}function e(a){return"\n        <li class=\"cbtb-ingredients-table\">\n            <span class=\"cbtb-ingredient-title\">".concat(a.title?q(a.title):"","</span>\n            <span class=\"cbtb-ingredient-amount\">").concat(a.amount?a.amount:"","</span>\n            <span class=\"cbtb-ingredient-unit\">").concat(a.unit?a.unit:"","</span>\n            <div class=\"cbtb-remove-button\"><span class=\"dashicons dashicons-dismiss\"></span></div>\n        </li>")}function f(){var a=h();return k(a),a}function g(){var a=f();r.push(a)}function h(){var a=document.getElementById("sortable_list");return Array.from(a.childNodes).filter(function(a){return a.nodeType!==Node.TEXT_NODE}).map(function(a){return i(a)})}function i(a){// parse ingredient items parts (aka. the current ingredient items DOM-subtree)
return Array.from(a.childNodes).filter(function(a){return a.nodeType!==Node.TEXT_NODE&&"span"===a.nodeName.toLowerCase()}).map(function(a){return j(a)}).reduce(function(a,b){if(b)return a[b.identifier]=b.text,a},{})}function j(a){if(!a.classList||1!==a.classList.length)throw"An ingredients components (".concat(D,") couldn't be parsed. Identifying class missing.");var b=a.classList[0].split("-");if(3!==b.length||!a.classList[0].startsWith("cbtb-ingredient-"))throw"An ingredients components (".concat(D,") couldn't be parsed. Identifying class invalid.");var c=a.classList[0].split("-")[2];return D.includes(c)?{identifier:c,text:a.innerText}:null}function k(a){var b=JSON.stringify(a);return G&&(console.log("Storing: ",b),console.table(a)),u.val(b),l(b),b}function l(a){z.toggle(!0);var b=wp.data.select("core/editor").getCurrentPostId();fetch("".concat(E,"cbtb-recipe/v1/recipe/").concat(b,"/ingredients"),{method:"PUT",body:a,headers:{"Content-Type":"application/json","X-WP-Nonce":F}}).then(function(a){G&&console.log(a),z.toggle(!1)})}function m(a){t.append(e(a)).sortable("refresh"),g()}function n(a){("div"===a.target.nodeName.toLowerCase()&&a.target.classList.contains("cbtb-remove-button")||"span"===a.target.nodeName.toLowerCase()&&a.target.classList.contains("dashicons-dismiss"))&&(a.target.closest("li").remove(),g())}function o(a,b){b.item.removeClass("cbtb-dragged")}function p(a,b){b.item.addClass("cbtb-dragged")}function q(a){var b=new DOMParser().parseFromString(a,"text/html");return b.body.textContent||""}var r,s,t=$("#sortable_list"),u=$("#cbtb_ingredients_field"),v=$("#list_item_adder"),w=$("#add-new-ingredient-title"),x=$("#add-new-ingredient-amount"),y=$("#add-new-ingredient-unit"),z=$("#cbtb-ingredients-list-save-notice"),A=$("#cbtb-ingredients-undo"),B=$("#cbtb-ingredients-redo"),C=[w,x,y],D=["title","amount","unit"],E=cbtbIngredientsRestSettings.root,F=cbtbIngredientsRestSettings.nonce,G=cbtbIngredientsRestSettings.loggingEnabled,H=/*#__PURE__*/function(){function a(b){_classCallCheck(this,a),this.history=[],this.history.push(b),this.pointer=0,B.css("color","#bcbcbc"),A.css("color","#bcbcbc")}return _createClass(a,[{key:"_atPresent",value:function _atPresent(){return this.pointer===this.history.length-1}},{key:"_atOldest",value:function _atOldest(){return 0===this.pointer}},{key:"push",value:function push(a){this._atPresent()||(this.history=this.history.slice(0,this.pointer)),this.history.push(a),this.pointer=this.history.length-1,this._decideOnButtonStates()}},{key:"undo",value:function undo(a){a.preventDefault(),this._atOldest()||(this.pointer-=1,this.makeHistory()),this._decideOnButtonStates()}},{key:"redo",value:function redo(a){a.preventDefault(),this._atPresent()||(this.pointer+=1,this.makeHistory()),this._decideOnButtonStates()}},{key:"_decideOnButtonStates",value:function _decideOnButtonStates(){this._atPresent()?B.css("color","#bcbcbc"):B.css("color","black"),this._atOldest()?A.css("color","#bcbcbc"):A.css("color","black")}},{key:"makeHistory",value:function makeHistory(){b(this.history[this.pointer]),f()}}]),a}();a()});

//# sourceMappingURL=ingredients-meta-list-compiled.js.map